<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-meta/iron-meta.html">
<!--
`<connectivity-state>` An element that detects online/offline states and informs about it other compopnents

Checking conectivity in browser is a tricky task. Browsers vendors can't agree
on what the online/offline status means and therefore event if the browser
says that it has intentet connection in reality it may not (because it may
have LAN aceess).

This element is doing whatever it's available in current browser to
inform other element about current conectivity state.

**Note: You can be sure that if the status is `offline` the browser is offline.
But when the status is onLine it may mean that there is a network konnected
but there's no internet connection (and therefore you are offline for the
outside world).**
In the element, if the `online` attribute is set to `false` the the app
is offline but when it's set to true it probably is online but may not have
access to the internet.

P.S.
Why there's not 3rd state alonside 'online' and 'offline' that will tell that
you are online meaning you have a network active but you are not have access to
the outside world?


### Example
```
<connectivity-state online="{{isOnline}}"></connectivity-state>
```
Other elements and/or app can access this information via Polymer's data binding system or:

1) By listening for an event `connectivity-state-changed`
```javascript
document.addEventListener('connectivity-state-changed', (e) => {
  // e.detail.online; (boolean, false is offline)
});
```
2) Reading value from the `<iron-meta>` element
```html
<iron-meta key="connectivity-state" value="{{networkOnline}}"></iron-meta>
```
3) In javascript using one of this methods:
```javascipt
// When Polymer is available in current namespace.
new Polymer.IronMetaQuery({key: 'connectivity-state'}).value;
// Otherwise
document.createElement('iron-meta').byKey('connectivity-state');
// false if offline.
```
Methods above are equal and can be used with this element.

@group Logic Elements
@element connectivity-state
@demo demo/index.html Connectivity demo
-->
<script>
Polymer({
  is: 'connectivity-state',
  properties: {
    /**
     * Current conectivity state.
     * If set to false then thete's no networ connection.
     * If true it means that the network is up an running and the app
     * is probably able to connect with the outside world but it's not
     * guaranteed.
     */
    online: {
      type: Boolean,
      value: true,
      notify: true,
      readOnly: true
    },
    /**
     * A reference to the `<iron-meta>` element.
     * @type {Object}
     */
    metaElement: {
      type: Object,
      value: function() {
        let meta = document.createElement('iron-meta');
        meta.key = 'connectivity-state';
        return meta;
      },
      notify: true,
      readOnly: true
    },
  },

  observers: [
    '_onlineStateChanged(online)'
  ],

  _onlineStateChanged: function(online) {
    if (this.metaElement) {
      this.metaElement.value = online;
    }
    this.fire('connectivity-state-changed', {
      online: online
    });
  },

  attached: function() {
    if (!navigator.onLine && !this.state) {
      // Change the default state.
      this._setOnline(false);
    }
    this.unlisten(window, 'offline', '_offlineHandler');
    this.unlisten(window, 'online', '_onlineHandler');

    this.listen(window, 'offline', '_offlineHandler');
    this.listen(window, 'online', '_onlineHandler');
  },

  detached: function() {
    this.unlisten(window, 'offline', '_offlineHandler');
    this.unlisten(window, 'online', '_onlineHandler');
  },

  _offlineHandler: function() {
    this._setOnline(false);
  },

  _onlineHandler: function() {
    this._setOnline(true);
  }

});
</script>
